# Twitter/X 推薦アルゴリズムの抽象化

## 概要
Twitter/Xの推薦アルゴリズムは、高度に最適化された多層パイプラインアーキテクチャで構成されています。このドキュメントは、その複雑なシステムを抽象化し、コア概念と設計パターンを整理したものです。

## 1. アーキテクチャの抽象モデル

### 1.1 4層パイプラインモデル
```
[候補生成] → [特徴抽出] → [スコアリング] → [ポストプロセス] → [配信]
```

### 1.2 各層の責務

#### 第1層：候補生成（Candidate Generation）
**目的**: 数百億のツイートから数千の候補を高速に選出

- **インネットワーク候補** (50%)
  - フォローしているユーザーのツイート
  - Earlybirdサーチインデックスから取得
  
- **アウトオブネットワーク候補** (50%)
  - グラフベース推薦（UTEG）
  - 協調フィルタリング（SimClusters）
  - コンテンツベース推薦（TwHIN埋め込み）

#### 第2層：特徴抽出（Feature Hydration）
**目的**: 各候補に対して約6000の特徴量を付与

- **ユーザー特徴**: プロファイル、行動履歴、興味
- **ツイート特徴**: コンテンツ、エンゲージメント、新鮮度
- **相互作用特徴**: ユーザー×ツイートの関係性
- **コンテキスト特徴**: 時間、デバイス、場所

#### 第3層：スコアリング（Scoring & Ranking）
**目的**: 機械学習モデルによる関連性スコア計算

- **軽量ランカー**: 初期フィルタリング（LogisticRegression）
- **重量ランカー**: 最終順位決定（深層学習モデル）
- **スコア統合**: 複数モデルのアンサンブル

#### 第4層：ポストプロセス（Post-Processing）
**目的**: ビジネスルールと品質保証の適用

- **多様性フィルタ**: 著者・トピックの多様性確保
- **品質フィルタ**: スパム、NSFW、誤情報の除去
- **疲労度管理**: 同一コンテンツの過剰露出防止
- **バランス調整**: In/Out-of-Network比率の最適化

## 2. コア設計パターン

### 2.1 マイクロサービス協調パターン
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Home-Mixer │────▶│  CR-Mixer   │────▶│Tweet-Mixer  │
└─────────────┘     └─────────────┘     └─────────────┘
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│Product-Mixer│     │   UTEG      │     │ SimClusters │
└─────────────┘     └─────────────┘     └─────────────┘
```

### 2.2 リアルタイム・バッチハイブリッドパターン

**リアルタイム処理**
- ユーザーアクション（いいね、RT）の即座反映
- グラフエッジの動的更新
- ホットトレンドの検出

**バッチ処理**
- 埋め込みベクトルの再計算（3週間周期）
- コミュニティ検出の更新
- 長期統計の集約

### 2.3 埋め込みベース推薦パターン

```
ユーザー → [埋め込み空間] ← ツイート
             ↓
        類似度計算
             ↓
         推薦候補
```

**主要埋め込みシステム**
- **SimClusters**: スパース埋め込み（145,000次元）
- **TwHIN**: 密埋め込み（200次元）
- **Real Graph**: ユーザー関係埋め込み

## 3. グラフベース推薦の抽象化

### 3.1 二部グラフモデル
```
[ユーザー] ─(エンゲージメント)→ [ツイート]
    ↓                              ↑
(フォロー)                    (作成)
    ↓                              │
[ユーザー] ←───────────────────────┘
```

### 3.2 グラフトラバーサル戦略
1. **1次接続**: 直接フォローのツイート
2. **2次接続**: フォローのフォローのツイート
3. **類似ユーザー**: 行動パターンが似たユーザーのツイート
4. **トピックベース**: 興味トピックに関連するツイート

## 4. 機械学習パイプラインの抽象化

### 4.1 特徴エンジニアリング
```
生データ → 前処理 → 特徴抽出 → 特徴選択 → 正規化
```

### 4.2 モデルアーキテクチャ
```
入力層（6000特徴）
    ↓
埋め込み層
    ↓
注意機構層
    ↓
深層ニューラルネット
    ↓
出力層（エンゲージメント確率）
```

### 4.3 最適化目標
- **主目標**: ユーザーエンゲージメント最大化
- **副目標**: 
  - 滞在時間の増加
  - ネガティブフィードバックの最小化
  - コンテンツ多様性の維持

## 5. スケーラビリティパターン

### 5.1 階層的キャッシング
```
L1: インメモリ（GraphJet）- 24-48時間
L2: Memcache - 数日
L3: Manhattan（分散KVS）- 永続化
```

### 5.2 近似アルゴリズム
- **ANN（近似最近傍探索）**: FAISSインデックス
- **サンプリング**: Metropolis-Hastingsアルゴリズム
- **量子化**: 埋め込みベクトルの圧縮

### 5.3 負荷分散戦略
- **シャーディング**: ユーザーIDベース
- **レプリケーション**: 読み取り負荷の分散
- **非同期処理**: イベント駆動アーキテクチャ

## 6. 品質保証メカニズム

### 6.1 A/Bテストフレームワーク
```
トラフィック → [実験グループ分割] → [処理バリアント] → [メトリクス測定]
```

### 6.2 フィードバックループ
```
ユーザー行動 → ログ収集 → 分析 → モデル改善 → デプロイ
     ↑                                        │
     └────────────────────────────────────────┘
```

### 6.3 安全性チェック
- **コンテンツフィルタ**: NSFWモデル
- **スパム検出**: アノマリー検出
- **フェイクニュース対策**: 信頼性スコアリング

## 7. 汎用化可能な設計原則

### 7.1 モジュラリティ
- 各コンポーネントは独立してスケール可能
- インターフェースは明確に定義
- 疎結合アーキテクチャ

### 7.2 観測可能性
- 全パイプラインステージでのメトリクス収集
- トレーシングによるレイテンシ分析
- リアルタイムダッシュボード

### 7.3 進化可能性
- Feature Toggleによる段階的ロールアウト
- バックワード互換性の維持
- カナリアデプロイメント

## まとめ

Twitter/Xの推薦アルゴリズムは、以下の要素を巧みに組み合わせた高度なシステムです：

1. **多段階フィルタリング**: 数百億から数十への効率的な絞り込み
2. **ハイブリッド推薦**: 協調フィルタリング＋コンテンツベース＋グラフベース
3. **リアルタイム性**: ミリ秒単位の応答時間と即座の更新
4. **スケーラビリティ**: 数億ユーザーに対応する分散アーキテクチャ
5. **品質保証**: 多様性、安全性、関連性のバランス

この抽象化モデルは、大規模ソーシャルメディアプラットフォームの推薦システム設計における最先端のアプローチを示しています。