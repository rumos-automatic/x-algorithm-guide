# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際のClaude Code (claude.ai/code)への指針を提供します。

## リポジトリ概要

これはTwitter（現X）のオープンソース推薦アルゴリズムリポジトリです。For Youタイムライン、検索、探索、通知を含む、すべてのXプロダクトサーフェスにわたって投稿やコンテンツのフィードを提供するサービスとジョブが含まれています。

## 技術スタック

- **主要言語**: Scala、Java、Python
- **ビルドシステム**: Bazel（BUILDおよびBUILD.bazelファイル）
- **機械学習**: TensorFlow（TWMLフレームワーク経由）、PyTorch
- **サービスフレームワーク**: Product Mixer（フィード構築用のカスタムScalaフレームワーク）

## 主要サービスとコンポーネント

### コアサービス

1. **home-mixer** - ホームタイムラインの構築と提供のメインサービス
   - 場所: `home-mixer/`
   - Product Mixerフレームワーク上に構築
   - For You、フォロー中、リストタイムラインを提供

2. **cr-mixer** - 候補取得ミキサー
   - 場所: `cr-mixer/`
   - ツイート候補取得の調整レイヤー

3. **tweet-mixer** - ネットワーク外ツイート候補の調整
   - 場所: `tweet-mixer/`

4. **tweetypie** - 投稿データの読み書きのコアサービス
   - 場所: `tweetypie/`

5. **timelineranker** - 関連性スコア付き投稿のレガシーサービス
   - 場所: `timelineranker/`

### 機械学習コンポーネント

1. **navi** - 高性能MLモデルサービング（Rust）
   - 場所: `navi/`

2. **twml** - TensorFlow v1上に構築されたレガシーMLフレームワーク
   - 場所: `twml/`
   - 注：開発は終了しているが、軽量ランカーモデルには引き続き使用

3. **representation-scorer** - エンベディングを使用したエンティティペア間のスコア計算
   - 場所: `representation-scorer/`

4. **SimClusters** - コミュニティ検出とスパースエンベディング
   - 場所: `src/scala/com/twitter/simclusters_v2/`

### グラフと推薦サービス

1. **user-tweet-entity-graph** (UTEG) - メモリ内ユーザー対投稿インタラクショングラフ
   - 場所: `src/scala/com/twitter/recos/user_tweet_entity_graph/`
   - GraphJetフレームワーク上に構築

2. **follow-recommendations-service** (FRS) - アカウントフォロー推薦
   - 場所: `follow-recommendations-service/`

3. **graph-feature-service** - ユーザーペアのグラフ特徴を提供
   - 場所: `graph-feature-service/`

## ビルドコマンド

このリポジトリはBazelをビルドシステムとして使用。一般的なパターン：

```bash
# ターゲットのビルド
bazel build //path/to/target:target_name

# テストの実行
bazel test //path/to/target:test_name

# ディレクトリ内のすべてのターゲットをビルド
bazel build //path/to/directory/...
```

注：具体的なビルドコマンドはサービスによって異なります。利用可能なターゲットは各サービスのBUILDファイルを確認してください。

## 開発ワークフロー

1. **サービス開発**: ほとんどのサービスはScalaで、Product Mixerフレームワークパターンに従う
2. **MLモデル開発**: モデルはTWML（レガシー）または新しいPyTorchベースのアプローチを使用
3. **テスティング**: サービスは通常、実装と並行してユニットテストを持つ
4. **設定**: 多くのサービスは実行時設定にフィーチャースイッチとデサイダーを使用

## アーキテクチャパターン

### パイプライン構造（Product Mixer）
- **プロダクトパイプライン**: 実行するミキサー/推薦パイプラインを選択
- **ミキサーパイプライン**: 複数の候補パイプラインからの結果を結合
- **推薦パイプライン**: 同種の候補をスコアリングしランク付け
- **候補パイプライン**: 基礎となるソースから候補を取得
- **スコアリングパイプライン**: ランキング用のMLモデルを適用

### データフロー
1. 候補生成 - 様々なソースからツイートを取得
2. 特徴ハイドレーション - ランキング用の特徴を取得（約6000特徴）
3. スコアリングとランキング - MLモデルを適用
4. フィルタリング - ビジネスロジックフィルターを適用
5. ミキシング - 広告や他のコンテンツと統合
6. サービング - レスポンスをフォーマットして返す

## 重要な注意事項

- このコードベースはTwitterのアルゴリズムのスナップショットであり、主に読み取り専用
- 多くの内部依存関係とサービスは含まれていない
- ビルドコマンドはTwitter/Xの内部インフラストラクチャが必要な場合がある
- コードベースはTwitter固有のライブラリとフレームワークを広範囲に使用